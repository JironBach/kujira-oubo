<%
  sidebar_collapse  = cookies["nonsidebar-collapse"]

  loginAccountObj = session["loginAccountObj"]
	message = params["message"]
	#GroupObject[] groupArray = (GroupObject[])request.getAttribute("groupArray");
  groupArray = SGroup.where(delete_flg: 0).all
	onePageLimit = session["one_page_limit"]
	mode = params["mode"]
	searchName = params["searchName"]
	searchManager = params["search_manager"]

	accountObjArray = Account.where(delete_flg: 0).all

	maxNum = 0;
  if(!groupArray.count > 0)
    maxNum = groupArray.count #[0].getMaxNum();
  end
  if (onePageLimit.nil? || (onePageLimit == ""))
		onePageLimit = "20";
	end
	oneLimit = onePageLimit.to_i

	pageNumStr = params["page_num"]
	if (pageNumStr.nil? || pageNumStr == "")
		pageNumStr = "1";
	end
	pageNum = pageNumStr.to_i
	maxPageCnt = ((maxNum + (oneLimit - 1)) / oneLimit);

	startPageNum = 1;
	endPageNum = 5;

	if (pageNum < 6)
		startPageNum = 1;
		if (maxPageCnt < 6)
			endPageNum = maxPageCnt;
		else
			endPageNum = 5;
		end
	else
		if((pageNum + 2) < maxPageCnt)
			startPageNum = pageNum - 2;
			endPageNum = pageNum + 2;
		else
			startPageNum = maxPageCnt - 4;
			endPageNum = maxPageCnt;
		end
	end

	searchMode = params["search_mode"]
	if (searchMode.nil? || searchMode == "")
		searchMode = "false";
	end

	startNum = ((pageNum -1 ) * onePageLimit.to_i) + 1; #０件でも１件〜となってしまうため修正要
	endNum   =  startNum - 1  + groupArray.length;

	prefEnableFlg = (pageNum < 2) ? false : true;
	highPrefEnableFlg = (pageNum < 6) ? false : true;

	nextEnableFlg = (pageNum < maxPageCnt) ? true : false;
	highNextEnableFlg = (pageNum < (maxPageCnt - 4)) ? true : false;

	highPreNum = pageNum - 5;
	if (highPreNum < 1)
		highPreNum = 1;
	end
	preNum = pageNum - 1;
	if (preNum < 1)
		preNum = 1;
	end
	highNextNum = pageNum + 5;
	if (highNextNum > maxPageCnt)
		highNextNum = maxPageCnt;
	end
	nextNum = pageNum + 1;
	if (nextNum > maxPageCnt)
		nextNum = maxPageCnt;
	end

	String dispSearchName="";
	if(mode == "search")
		dispSearchName = searchName;
	else
	end

  if loginAccountObj.nil?
    pict = ''
  else
    ss = loginAccountObj['fullname']
    pict = ss.slice(0, 1)
  end
%>
<!DOCTYPE html>
<html>
 <head>
  <%= render partial: "common/index_header" %>
  <title>くじら応募</title>
  <script src="/dist/js/jquery.js"></script>
  <script src="/dist/js/bootstrap.js"></script>
  <script src="/dist/js/adminlte.js?v=1"></script>
  <script>
			document.addEventListener('DOMContentLoaded', function() {
				//alert('come in DOM!!!!!!!!!');
				selectedOnePageLimit();
				setSearchValue();
			});
			function selectedOnePageLimit(){
                document.getElementById('txt_one_page_limit').value = "<%=onePageLimit%>";
                document.getElementById('txt_one_page_limit2').value = "<%=onePageLimit%>";
			}
			function setParam(name,value){
				var input = document.createElement('input');
                input.setAttribute('type', 'hidden');
                input.setAttribute('name', name);
                input.setAttribute('value', value);
                return input;
			}

			function setSearchValue(){
				document.getElementById("cmb_group_manager").value = '<%=searchManager%>';
			}


			/*function toGroupUpd(id){
				var inputId = setParam('app_group_id',id);
				var inputPageNumStr   = setParam('pageNumStr','${param.pageNumStr}');
				var f = document.createElement("form");
                f.setAttribute('method',"post");

                f.setAttribute('action',"/setting_group_upd");
				f.appendChild(inputId);
				f.appendChild(inputPageNumStr);
				var bodyElement = document.body;
				bodyElement.append(f);
				f.submit();
			}*/
			function toGroupUpd(id,name,manager,managerComment){

				var inputId = setParam('app_group_id',id);
				var inputName = setParam('app_group_name',name);
				var inputManager = setParam('app_group_manager',manager);
				var inputAdminComment = setParam('app_admin_comment',managerComment);
				var inputPageNumStr   = setParam('pageNumStr','${param.pageNumStr}');
				var f = document.createElement("form");
                f.setAttribute('method',"post");

                f.setAttribute('action',"/setting_group_upd");
				f.appendChild(inputId);
				f.appendChild(inputName);
				f.appendChild(inputManager);
				f.appendChild(inputAdminComment);
				f.appendChild(inputPageNumStr);
				var bodyElement = document.body;
				bodyElement.append(f);
				f.submit();
			}
			function toServlet(mode,num, onePageLimit){
				var inputOnePageLimit = setParam("one_page_limit",onePageLimit);
				var inputMode = setParam("mode",mode);
				var f = document.createElement("form");
				f.setAttribute('method',"post");
				f.setAttribute('action',"/setting_group/"+num);
				f.appendChild(inputOnePageLimit);
				f.appendChild(inputMode);
				if(mode == "search"){
					var searchName = document.getElementById("txtSearchName").value;
					var manager    = document.getElementById("cmb_group_manager").value;
					var inputSearchName = setParam('searchName',searchName);
					var inputSearchManager = setParam('search_manager',manager);
					f.appendChild(inputSearchName);
					f.appendChild(inputSearchManager);
			   }
				var bodyElement = document.body ;
                bodyElement.append(f);
				f.submit();
			}

			function onePageLimit(){
				toServlet('<%=mode%>',getPageNumber(), document.activeElement.value);
			}
			function moveList(num) {
				toServlet('<%=mode%>',num, document.getElementById("txt_one_page_limit").value);
			}
			function nowList(){
			}
			function searchGroup(){
				toServlet("search",1, document.getElementById("txt_one_page_limit").value);
			}
			function deleteCol(deleteArr){
				var page = <%=pageNumStr%>;
				var inputId = setParam('delete_id_arr',deleteArr);
				var inputPageNumStr = setParam('pageNumStr','<%=pageNumStr%>');
				var f = document.createElement("form");
                f.setAttribute('method',"post");
                f.setAttribute('action',"/setting_group_delete");
                f.appendChild(inputId);
                f.appendChild(inputPageNumStr);
				var bodyElement = document.body ;
                bodyElement.append(f);
                f.submit();
			}
			function resetSearchInfo() {
				toServlet("no_search",1,document.getElementById("txt_one_page_limit").value);
			}
			//以下はデータ取得メソッド
			function getPageNumber(){
				return <%=pageNumStr%>;
		    }
		</script>
		<script>

			$(function() {
    			//final action button
    			take_get_parameter();
   			});

			function take_get_parameter() {
				var del_row_no = S_GET("del_row_no");
				$("#row_" + del_row_no).remove();
			}

			function redirect_page(){

			}

			//delete single & mass
			function delete_per_line(index){
				var del_conf = confirm("削除します。よろしいですか？");

				if (del_conf == true){
					//$("#row_"+index).remove();
					deleteCol(index);
				}
			}
			function delete_all_line(){
				if (get_total_selected_rad() > 0) {
					var del_conf = confirm("削除します。よろしいですか？");
					var index = new Array();
					var counter = 0;

					if (del_conf == true) {

						var rad = document.getElementsByName("cb_data");
						var deleteArr = '';
						for (var i = 0; i < rad.length; i++) {
							if(rad[i].checked == true){
								index[counter] = rad[i].value;
								deleteArr = deleteArr + ','+rad[i].value;
								counter ++;
							}
						}

						if(counter > 0){
						    deleteCol(deleteArr);
						}

						document.getElementById("cb_data_x").checked = false;
					}
				}
				else
					alert("削除処理対象を選択してください。");
			}

			function check_all(){
				var rad = document.getElementsByName("cb_data");
				var rad_all = document.getElementById("cb_data_x");

				for (var i = 0; i < rad.length; i++) {
					if (rad_all.checked == true)
						rad[i].checked = true;
					else
						rad[i].checked = false;
				}
			}

			function get_total_selected_rad(){
				var rad = document.getElementsByName("cb_data");
				var counter = 0;

				for (var i = 0; i < rad.length; i++) {
					if(rad[i].checked == true)
						counter ++;
				}

				return counter;
			}

  </script>
 </head>
 <body class="hold-transition skin-kujira sidebar-mini <%=sidebar_collapse%>">
  <div class="wrapper">
   <%= render partial: "/common/top_bar" %>
   <%= render partial: "/common/side_bar" %>
   <div class="content-wrapper">
    <section class="content-header">
     <h1>グループ設定</h1>
     <ol class="breadcrumb">
      <li><a href="/"><i class="fa fa-home"></i> ホーム</a></li>
      <li><a href="/setting_group"><i class="fa fa-cogs"></i> 設定</a></li>
      <li class="active">グループ設定</li>
     </ol>
    </section>
    <section class="content">
     <div class="row">
      <section class="col-md-12 col-xs-12">
       <div class="callout callout-warning">
        <h4 style="font-size:16px;">グループ一覧</h4>
       </div>
       <div class="row">
        <div class="col-md-12 col-xs-12">
         <div class="box box-kujira box-solid">
          <div class="box-header with-border">
           検索メニュー
          </div>
          <div class="box-body">
           <div class="col-md-12 col-xs-12">
            <div class="form-group">
             <div class="pull-right">
              <a style="color:#000;" class="btn btn-rounded btn-kujira" href="" onClick="resetSearchInfo(); return false;">検索項目をリセット</a>
             </div>
            </div>
           </div>
           <div class="form-group">
           	<div class="col-md-3 col-xs-12"></div>
           	<div class="col-md-3 col-xs-12">
           	 <label style="font-size: 12px;">グループ名</label>
           	 <input class="form-control" id="txtSearchName" value="<%=searchName%>" type="text" placeholder="グループ名" />
           	</div>
           	<div class="col-md-3 col-xs-12">
           	 <label style="font-size: 12px;">担当名</label>
           	 <select class="form-control" id="cmb_group_manager">
           	  <option value="">選択してください。</option>
           	  <% accountObjArray.each do |account| %>
           	    <option value="<%=account.id%>"><%=account.fullname%></option>
           	  <% end %>
           	 </select>
           	</div>
           	<div class="col-md-3 col-xs-12"></div>
           </div>
          </div>
          <div class="box-body">
           <div class="col-md-12 col-xs-12">
           	<div class="text-center">
           	 <button class="btn btn-rounded btn-kujira" id="search_button" onClick="searchGroup()">検索</button>
           	</div>
           </div>
          </div>
         </div>
        </div>
       </div>
       <br>
       <div class="row">
        <div class="col-md-12 col-xs-12">
         <div class="pull-left">
          <%=maxNum%> 件中 <%=startNum%> ~ <%=endNum%> 件表示
         </div>
         <div class="pull-right">
          <select class="form-control" id="txt_one_page_limit" onchange="onePageLimit()">
           <option value="20">20件</option>
           <option value="50">50件</option>
           <option value="100">100件</option>
          </select>
         </div>
        </div>
       </div>
       <div class="row">
        <div class="col-md-12 col-xs-12 text-center">
         <ul class="pagination">
          <% if (highPrefEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=highPreNum%>); return false;"><<</a></li>
          <% end %>
          <% if (prefEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=preNum%>); return false;"><</a></li>
          <% end %>
          <% if (pageNum >= 10) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(1); return false;">1</a></li>
            <li id ="omission_list"><a href="javascript:void(0)" >...</a></li>
          <% end %>
          <% endPageNum.times do |i| %>
            <% if (i == pageNum) %>
              <li class="active" id ="selected_list"><a href="javascript:void(0)" ><%=i%></a></li>
            <% else %>
              <li id ="non_selected_list"><a href="#" onClick="moveList(<%=i%>); return false;"><%=i%></a></li>
            <% end %>
          <% end %>
          <% if (nextEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=nextNum%>); return false;">></a></li>
          <% end %>
          <% if (highNextEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=highNextNum%>); return false;">>></a></li>
          <% end %>
         </ul>
        </div>
       </div>
       <div class="row">
        <div class="col-md-12 col-xs-12">
         <div class="pull-left">
          <a style="color:#000;" id="btn_create_new" href="/setting_group_create" class="btn btn-kujira">新規登録</a>
         </div>
         <div class="pull-right">
          <a class="btn btn-rounded btn-danger" onclick="delete_all_line()" id="btn_delete_all_0">一括削除</a>
         </div>
        </div>
       </div>
       <br>
       <div class="row">
        <div class="col-md-12">
         <div class="responsive-table">
          <table class="table table-striped table-bordered">
           <thead>
       	    <tr>
             <th scope="col"><center>
              <label class="switch">
               <input onclick="check_all()" id="cb_data_x" class="input_form_field_radio" type="checkbox" value="">
               <span class="slider round"></span>
              </label>
              </center>
             </th>
             <th style="font-size:12px;" scope="col"><b>グループID</b></th>
             <th style="font-size:12px;" scope="col"><b>グループ名</b></th>
             <th style="font-size:12px;" scope="col"><b>グループ担当者</b></th>
             <th style="font-size:12px;" scope="col"><b>作成日<br>最終更新日</b></th>
             <th style="font-size:12px;" scope="col"><b>操作</b></th>
            </tr>
           </thead>
           <tbody>
           	<% groupArray.each do |group| %>
           	 <tr id="row_0">
       	      <th style="font-size:12px;" scope="row">
       	       <center>
       	       	<label class="switch">
       	       	 <input class="input_form_field_radio" name="cb_data" id="cb_data_2" value='<%=group.id%>' type="checkbox"/>
       	       	 <span class="slider round"></span>
       	       	</label>
       	       </center>
       	      </th>
       	      <td style="font-size:12px;" data-title="グループID"><%=group.id%></td>
       	      <td style="font-size:12px;" data-title="グループ名"><a href="javascript:void(0)" onClick="toGroupUpd('<%=group.id%>','<%=group.name%>','<%=group.manager%>','<%=group.admin_comment%>')"><%=group.name%></a></td>
       	      <td style="font-size:12px;" data-title="グループ担当者"><%=group.manager%></td>
       	      <%
       	       createTime = Common.make_japanese_time(group.created_at)
       	       finalCreateTime = createTime.slice(0, 16);

       	       updateTime = Common.make_japanese_time(group.updated_at)
       	       finalUpdateTime = updateTime.slice(0, 16);
       	      %>

       	      <td style="font-size:12px;" data-title="作成日 / 最終更新日"><%=finalCreateTime%><br/><%=finalUpdateTime%></td>
       	      <td style="font-size:12px;" data-title="操作">
       	       <div class="text-center">
       	       	<a id="edit_row_2" href="javascript:void(0)" onClick="toGroupUpd('<%=group.id%>','<%=group.name%>','<%=group.manager%>','<%=group.admin_comment%>')">編集</a> |
       	       	<a id="delete_row_2" href="javascript:void(0)" onclick="delete_per_line('<%=group.id%>')">削除</a>
       	       </div>
       	      </td>
           	 </tr>
           	<% end %>
           </tbody>
          </table>
         </div>
        </div>
       </div>
       <div class="row">
        <div class="col-md-12 col-xs-12">
         <div class="pull-left">
          <a style="color:#000;" id="btn_create_new" href="/setting_group_create" class="btn btn-kujira">新規登録</a>
         </div>
         <div class="pull-right">
          <a class="btn btn-rounded btn-danger" onclick="delete_all_line()" id="btn_delete_all_0">一括削除</a>
         </div>
        </div>
       </div>
       <br>
       <div class="row">
        <div class="col-md-12 col-xs-12">
         <div class="pull-left">
          <%=maxNum%> 件中 <%=startNum%> ~ <%=endNum%> 件表示
         </div>
         <div class="pull-right">
          <select class="form-control" id="txt_one_page_limit" onchange="onePageLimit()">
           <option value="20">20件</option>
           <option value="50">50件</option>
           <option value="100">100件</option>
          </select>
         </div>
        </div>
       </div>
       <div class="row">
        <div class="col-md-12 col-xs-12 text-center">
         <ul class="pagination">
          <% if (highPrefEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=highPreNum%>); return false;"><<</a></li>
          <% end %>
          <% if (prefEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=preNum%>); return false;"><</a></li>
          <% end %>
          <% if (pageNum >= 10) %>
          <li id ="non_selected_list"><a href="#" onClick="moveList(1); return false;">1</a></li>
          <li id ="omission_list"><a href="javascript:void(0)" >...</a></li>
          <% end %>
          <% endPageNum.times do |i| %>
            <% if (i == pageNum) %>
              <li class="active" id ="selected_list"><a href="javascript:void(0)" ><%=i%></a></li>
            <% else %>
              <li id ="non_selected_list"><a href="#" onClick="moveList(<%=i%>); return false;"><%=i%></a></li>
            <% end %>
          <% end %>
          <% if (nextEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=nextNum%>); return false;">></a></li>
          <% end %>
          <% if (highNextEnableFlg) %>
            <li id ="non_selected_list"><a href="#" onClick="moveList(<%=highNextNum%>); return false;">>></a></li>
          <% end %>
         </ul>
        </div>
       </div>
      </section>
     </div>
    </section>
   </div>
   <%= render partial: "common/footer" %>
  </div>
  <script>
$(document).ready(function() {
    // get current URL path and assign 'active' class
    var pathname = window.location.pathname;
    $('.setting').parent().addClass('active') && $('.setting > li > a[href="'+pathname+'"]').parent().addClass('active');
})
  </script>
 </body>
</html>
